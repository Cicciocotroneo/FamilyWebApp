<!DOCTYPE html>
<html lang="it">
<head>
 <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Hub</title>
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Family Hub">
    
    <link rel="apple-touch-icon" href="icon.png">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- RESET E BASI --- */
        body { background-color: #f4f6f8; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        * { box-sizing: border-box; } 

        /* --- HEADER --- */
        header { 
            background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; 
        }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        
        /* --- BARRA INSERIMENTO (MOBILE PERFECT) --- */
        .add-bar {
            background: white; padding: 15px; margin: 15px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start;
        }

        /* Stili Unificati per Input/Select/Button */
        .add-bar select, .add-bar input, #add-btn,
        .note-editor input, .note-editor button, .admin-panel input, .admin-panel button {
            height: 48px !important; width: 100%;
            border: 1px solid #e0e0e0; border-radius: 12px;
            background-color: #fff; font-size: 16px; padding: 0 12px;
            color: #333; margin: 0; appearance: none; -webkit-appearance: none; outline: none;
        }

        /* Icona per le select */
        .add-bar select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 10px auto;
        }

        /* Colori Assegnazione */
        #assign-who { background-color: #fff8e1; border-color: #ffecb3; color: #ff6f00; font-weight: 600; }
        
        /* GRUPPO TESTO + BOTTONE (FIX ALLINEAMENTO) */
        .input-text-group { 
            grid-column: 1 / -1; display: flex; gap: 10px; align-items: stretch; /* Altezza uguale forzata */
        }
        #new-item-input { flex-grow: 1; border: 2px solid #4285f4; background-image: none; }
        #contact-detail-input { grid-column: 1 / -1; }

        #add-btn { 
            width: 50px !important; padding: 0; background: #4285f4; color: white; border: none; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3); 
        }
        #add-btn:active { transform: scale(0.95); }

        /* --- EDITOR NOTE --- */
        .note-editor {
            background: #fff9c4; padding: 15px; margin: 15px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px; border: 1px solid #fbc02d;
        }
        .note-editor textarea {
            width: 100%; height: 150px; border: 1px solid #e0e0e0; border-radius: 12px;
            background-color: #fff; font-size: 16px; padding: 12px;
            color: #333; font-family: inherit; resize: none; outline: none;
        }
        #save-note-btn { background: #fbc02d; color: #333; font-weight: bold; border: none; box-shadow: 0 4px 10px rgba(251, 192, 45, 0.3); cursor: pointer; }

        .hidden { display: none !important; }

        /* LISTE */
        #list-container { padding: 0 15px 120px 15px; } 
        .card { background: white; padding: 16px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; scroll-margin-top: 140px; }
        
        /* NOTE CARD */
        .note-card { flex-direction: column; align-items: flex-start; gap: 10px; border-left: 5px solid #fbc02d; }
        .note-title { font-weight: 800; font-size: 1.1rem; color: #333; width: 100%; }
        .note-body { white-space: pre-wrap; color: #555; font-size: 0.95rem; line-height: 1.4; width: 100%; }
        .note-footer { width: 100%; display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }

        /* AGENDA STYLES */
        .date-badge { background: #e8f0fe; color: #1967d2; padding: 6px 10px; border-radius: 10px; text-align: center; margin-right: 15px; min-width: 50px; display: flex; flex-direction: column; justify-content: center; font-weight: bold; }
        .date-day { font-size: 1.4rem; line-height: 1; }
        .date-month { font-size: 0.7rem; text-transform: uppercase; margin-top: 2px; }
        .today-card { border-left: 5px solid #4285f4; background: #f8fbff; } /* Evidenzia Oggi */
        .time-display { font-size: 0.85rem; background: #eee; padding: 2px 6px; border-radius: 4px; margin-right: 5px; color: #333; font-weight: bold; }
        .due-date-display { font-size: 0.75rem; color: #d32f2f; font-weight: bold; display: block; margin-top: 2px; }
        
        .cat-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
        .assigned-badge { font-size: 0.75rem; background: #eee; color: #555; padding: 3px 8px; border-radius: 6px; margin-left: 8px; display: inline-block; vertical-align: middle; }
        
        /* NAVIGAZIONE */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 12px 0 25px 0; z-index: 200; box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        .nav-item { background: none; border: none; color: #999; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; }
        .nav-item.active { color: #4285f4; }
        .nav-item i { font-size: 26px; margin-bottom: 4px; }
        
        /* IMPOSTAZIONI & LOGIN */
        .settings-view { padding: 20px; padding-bottom: 100px; }
        .settings-section { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .admin-panel { border: 2px solid #ff9800; background: #fff3e0; }
        
        #auth-container { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; background: white; }
        #auth-container input { width: 100%; height: 50px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; padding: 0 15px; font-size: 16px; }
        #login-btn { width: 100%; height: 50px; background: #4285f4; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; }
        #filter-select { border: none; background: #f0f2f5; padding: 8px 12px; border-radius: 8px; font-weight: 600; color: #333; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="auth-container">
        <h1 style="color:#4285f4; font-size: 2.5rem; margin-bottom: 10px;">Family Hub</h1>
        <p style="color:#888; margin-bottom: 40px;">Il centro della tua casa.</p>
        <input type="email" id="email-input" placeholder="Email">
        <input type="password" id="password-input" placeholder="Password">
        <button id="login-btn">Entra</button>
        
        <p onclick="window.resetPassword()" style="color:#4285f4; cursor:pointer; margin-top:15px; text-decoration:underline;">Password dimenticata?</p>
        
        <p id="login-status" style="margin-top: 20px; color: #666; font-size: 0.9rem;"></p>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <div>
                <h2 id="page-title" style="margin:0; font-size: 1.4rem;">Agenda</h2>
                <span id="family-display" style="font-size:0.75rem; color:#888; font-weight: 500;">Caricamento...</span>
            </div>
            <div class="header-controls">
                <select id="filter-select" onchange="window.applyFilter()">
                    <option value="all">Tutti</option>
                </select>
                <i class="material-icons" onclick="window.nav('settings')" style="color:#555; cursor:pointer;">settings</i>
                <i class="material-icons" onclick="window.logout()" style="color:#333; cursor:pointer;">logout</i>
            </div>
        </header>

        <main>
            <div id="add-bar-container" class="add-bar">
                
                <input type="date" id="date-input" class="hidden">
                <input type="time" id="time-input" class="hidden" style="width:100%;">
                
                <select id="recurrence-select" class="hidden">
                    <option value="none">1 volta</option>
                    <option value="weekly">Settimana</option>
                    <option value="monthly">Mese</option>
                    <option value="yearly">Anno</option>
                </select>

                <select id="category-select" class="hidden"></select>
                <select id="assign-who" class="hidden"></select>
                <input type="text" id="contact-detail-input" class="hidden" placeholder="Numero o Email">

                <div class="input-text-group">
                    <input type="text" id="new-item-input" placeholder="Aggiungi...">
                    <button id="add-btn"><i class="material-icons">add</i></button>
                </div>
            </div>

            <div id="note-editor-container" class="note-editor hidden">
                <h4 style="margin:0; color:#f9a825;">Nuova Nota</h4>
                <input type="text" id="note-title-input" placeholder="Titolo della nota">
                <textarea id="note-content-input" placeholder="Scrivi qui il contenuto..."></textarea>
                <button id="save-note-btn">SALVA NOTA</button>
                <input type="hidden" id="editing-note-id">
            </div>

            <div id="list-container"></div>

            <div id="settings-view" class="hidden settings-view">
                
                <div id="super-admin-area" class="settings-section admin-panel hidden">
                    <h4 style="margin:0 0 10px 0; color:#e65100;">ðŸ‘‘ Console Super Admin</h4>
                    <p style="font-size:0.8rem; margin-bottom:10px;">Associa nuovi utenti a famiglie.</p>
                    <input type="email" id="admin-user-email" placeholder="Email Utente" style="margin-bottom:10px;">
                    <input type="text" id="admin-family-code" placeholder="Codice Famiglia (es. ROSSI)" style="margin-bottom:10px; text-transform:uppercase;">
                    <button onclick="window.adminAssociate()" style="background:#e65100; color:white; border:none; width:100%;">ASSOCIA ORA</button>
                    <p id="admin-status" style="font-size:0.8rem; margin-top:5px;"></p>
                </div>

                <h3 style="margin-top:0;">Gestione Famiglia</h3>
                
                <div class="settings-section" style="border:1px solid #4285f4;">
                    <h4 style="margin:0 0 10px 0; color:#4285f4;">Il Tuo Account</h4>
                    <div class="settings-row" style="display:block;">
                        <span style="display:block; margin-bottom:5px; font-size:0.9rem;">Cambia la tua Password</span>
                        <div style="display:flex; gap:10px;">
                            <input type="password" id="new-password-input" placeholder="Nuova Password" style="margin:0; flex-grow:1;">
                            <button onclick="window.changeUserPassword()" style="background:#4285f4; color:white; border:none; width:auto; padding:0 15px; border-radius:8px;">Aggiorna</button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 style="margin:0 0 10px 0;">Membri</h4>
                    <div id="members-list"></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <input type="text" id="new-member-name" placeholder="Nuovo membro" style="margin:0; flex-grow:1;">
                        <button onclick="window.addMember()" style="background:#4285f4; color:white; border:none; width:40px; border-radius:8px;">+</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 style="margin:0 0 10px 0;">Categorie</h4>
                    <div id="categories-list"></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <input type="text" id="new-cat-name" placeholder="Categoria" style="margin:0; flex-grow:1;">
                        <input type="color" id="new-cat-color" value="#4285f4" style="width:40px; padding:0; height:40px; border:none; border-radius:50%; margin:0;">
                        <button onclick="window.addCategory()" style="background:#4285f4; color:white; border:none; width:40px; border-radius:8px;">+</button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item" onclick="window.nav('calendar')"><i class="material-icons">event</i> Agenda</button>
            <button class="nav-item active" onclick="window.nav('shopping')"><i class="material-icons">shopping_cart</i> Spesa</button>
            <button class="nav-item" onclick="window.nav('todos')"><i class="material-icons">check_circle</i> Compiti</button>
            <button class="nav-item" onclick="window.nav('contacts')"><i class="material-icons">contacts</i> Rubrica</button>
            <button class="nav-item" onclick="window.nav('notes')"><i class="material-icons">sticky_note_2</i> Note</button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, orderBy, serverTimestamp, getDoc, setDoc, where } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // Import Completo per Auth e Reset
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider, sendPasswordResetEmail } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURAZIONE FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyCV51Ge3znsE6TPnQrJeEiNasz5YXtFWXk",
  authDomain: "drgfamilyhub.firebaseapp.com",
  projectId: "drgfamilyhub",
  storageBucket: "drgfamilyhub.firebasestorage.app",
  messagingSenderId: "709925755710",
  appId: "1:709925755710:web:6ebb2967fbc107447f6a6f"
};
        // --------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- EMAIL SUPER ADMIN ---
        const SUPER_ADMIN_EMAIL = "antonioderosa@gmail.com";

        let currentSection = 'shopping';
        let currentFamily = null;
        let unsubscribe = null; 
        let allDataCache = []; 
        let familySettings = { members: ["Mamma", "PapÃ "], categories: [{name:"Casa", color:"#4285f4"}] };

        // DOM ELEMENTS
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const listContainer = document.getElementById('list-container');
        const settingsView = document.getElementById('settings-view');
        const addBarContainer = document.getElementById('add-bar-container');
        const noteEditorContainer = document.getElementById('note-editor-container');
        const loginStatus = document.getElementById('login-status');
        
        // Inputs
        const categorySelect = document.getElementById('category-select');
        const assignWho = document.getElementById('assign-who');
        const filterSelect = document.getElementById('filter-select');
        const dateInput = document.getElementById('date-input');
        const timeInput = document.getElementById('time-input'); 
        const recurrenceSelect = document.getElementById('recurrence-select');
        const contactInput = document.getElementById('contact-detail-input');
        const newItemInput = document.getElementById('new-item-input');
        
        // Notes
        const noteTitleInput = document.getElementById('note-title-input');
        const noteContentInput = document.getElementById('note-content-input');
        const editingNoteId = document.getElementById('editing-note-id');

        document.getElementById('login-btn').addEventListener('click', () => {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('password-input').value;
            if(!email || !pass) return;
            loginStatus.innerText = "Accesso...";
            signInWithEmailAndPassword(auth, email, pass).catch(e => loginStatus.innerText = "Errore: " + e.message);
        });

        // NUOVA FUNZIONE: RESET PASSWORD DIMENTICATA
        window.resetPassword = async () => {
            const email = document.getElementById('email-input').value;
            if(!email) return alert("Inserisci prima la tua email nel campo qui sopra!");
            if(confirm(`Inviare link di reset password a: ${email}?`)) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    alert("Link inviato! Controlla la posta (anche spam).");
                } catch (error) { alert("Errore: " + error.message); }
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // SUPER ADMIN CHECK
                if (user.email === SUPER_ADMIN_EMAIL) {
                    document.getElementById('super-admin-area').classList.remove('hidden');
                } else {
                    document.getElementById('super-admin-area').classList.add('hidden');
                }

                try {
                    const userDoc = await getDoc(doc(db, "registro_utenti", user.email));
                    if (userDoc.exists()) {
                        currentFamily = userDoc.data().famiglia;
                        authContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        document.getElementById('family-display').innerText = `Famiglia: ${currentFamily}`;
                        await loadSettings();
                        loadData(currentSection);
                    } else { 
                        if (user.email === SUPER_ADMIN_EMAIL) {
                            currentFamily = "ADMIN"; 
                            authContainer.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            window.nav('settings'); 
                        } else {
                            alert("Utente non configurato."); signOut(auth); 
                        }
                    }
                } catch (error) { loginStatus.innerText = "Errore connessione."; }
            } else { authContainer.classList.remove('hidden'); appContainer.classList.add('hidden'); }
        });

        window.logout = () => signOut(auth);

        // FUNZIONE SUPER ADMIN
        window.adminAssociate = async () => {
            const email = document.getElementById('admin-user-email').value.trim();
            const code = document.getElementById('admin-family-code').value.trim().toUpperCase();
            const status = document.getElementById('admin-status');
            
            if(!email || !code) return alert("Compila tutto");
            try {
                await setDoc(doc(db, "registro_utenti", email), { famiglia: code });
                status.innerText = `âœ… Successo: ${email} -> ${code}`;
                status.style.color = "green";
                document.getElementById('admin-user-email').value = "";
            } catch(e) {
                status.innerText = "Errore: " + e.message;
                status.style.color = "red";
            }
        };

        async function loadSettings() {
            onSnapshot(doc(db, "settings", currentFamily), (docSnap) => {
                if (docSnap.exists()) familySettings = { ...familySettings, ...docSnap.data() };
                else setDoc(doc(db, "settings", currentFamily), familySettings);
                renderDropdowns(); renderSettingsView();
            });
        }
        async function saveSettings() { await setDoc(doc(db, "settings", currentFamily), familySettings); }

        window.changeUserPassword = async () => {
            const newPass = document.getElementById('new-password-input').value;
            if(newPass.length < 6) return alert("Minimo 6 caratteri!");
            try { await updatePassword(auth.currentUser, newPass); alert("Password aggiornata!"); document.getElementById('new-password-input').value=""; }
            catch (error) {
                if (error.code === 'auth/requires-recent-login') {
                    const currentPass = prompt("Reinserisci la tua password ATTUALE per sicurezza:");
                    if(currentPass) {
                        try {
                            await reauthenticateWithCredential(auth.currentUser, EmailAuthProvider.credential(auth.currentUser.email, currentPass));
                            await updatePassword(auth.currentUser, newPass);
                            alert("Password aggiornata!");
                            document.getElementById('new-password-input').value="";
                        } catch(e) { alert("Password errata."); }
                    }
                } else alert("Errore: " + error.message);
            }
        };

        function renderDropdowns() {
            categorySelect.innerHTML = "";
            familySettings.categories.forEach(cat => categorySelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`);
            filterSelect.innerHTML = `<option value="all">Tutti</option>`;
            familySettings.categories.forEach(cat => filterSelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`);
            assignWho.innerHTML = `<option value="">Per: Tutti</option>`;
            familySettings.members.forEach(mem => assignWho.innerHTML += `<option value="${mem}">${mem}</option>`);
        }

        window.nav = (section) => {
            if (section === 'settings') {
                currentSection = 'settings';
                listContainer.classList.add('hidden'); addBarContainer.classList.add('hidden'); noteEditorContainer.classList.add('hidden');
                settingsView.classList.remove('hidden'); document.getElementById('page-title').innerText = "Impostazioni";
                return;
            }

            currentSection = section;
            listContainer.classList.remove('hidden'); settingsView.classList.add('hidden');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            if(event && event.currentTarget) event.currentTarget.classList.add('active'); 
            
            // RESET
            dateInput.classList.add('hidden'); timeInput.classList.add('hidden'); recurrenceSelect.classList.add('hidden'); 
            categorySelect.classList.add('hidden'); assignWho.classList.add('hidden'); contactInput.classList.add('hidden'); 
            newItemInput.placeholder = "Aggiungi...";
            const title = document.getElementById('page-title');
            
            if (section === 'notes') {
                addBarContainer.classList.add('hidden'); noteEditorContainer.classList.remove('hidden'); title.innerText = "Note";
                noteTitleInput.value = ""; noteContentInput.value = ""; editingNoteId.value = "";
                document.getElementById('save-note-btn').innerText = "SALVA NOTA";
            } else {
                addBarContainer.classList.remove('hidden'); noteEditorContainer.classList.add('hidden'); 
                
                if(section === 'calendar') {
                    title.innerText = "Agenda"; 
                    dateInput.classList.remove('hidden'); timeInput.classList.remove('hidden'); 
                    recurrenceSelect.classList.remove('hidden'); 
                    categorySelect.classList.remove('hidden'); categorySelect.style.display = 'block'; 
                    assignWho.classList.remove('hidden'); assignWho.style.display = 'block'; 
                    newItemInput.placeholder = "Evento...";
                } 
                else if (section === 'todos') {
                    title.innerText = "Compiti"; 
                    dateInput.classList.remove('hidden'); // Data scadenza
                    categorySelect.classList.remove('hidden'); categorySelect.style.display = 'block'; 
                    assignWho.classList.remove('hidden'); assignWho.style.display = 'block'; 
                    newItemInput.placeholder = "Compito...";
                } 
                else if (section === 'contacts') {
                    title.innerText = "Rubrica"; contactInput.classList.remove('hidden'); newItemInput.placeholder = "Nome...";
                } else { title.innerText = "Spesa"; newItemInput.placeholder = "Cosa manca?"; }
            }
            loadData(section);
        };

        function renderSettingsView() {
            const memList = document.getElementById('members-list'); memList.innerHTML = "";
            familySettings.members.forEach((mem, i) => memList.innerHTML += `<div class="settings-row"><span>${mem}</span><i class="material-icons" style="color:red; cursor:pointer;" onclick="window.removeMember(${i})">delete</i></div>`);
            const catList = document.getElementById('categories-list'); catList.innerHTML = "";
            familySettings.categories.forEach((cat, i) => catList.innerHTML += `<div class="settings-row"><div style="display:flex;align-items:center"><span style="width:20px;height:20px;background:${cat.color};border-radius:50%;margin-right:10px;"></span>${cat.name}</div><i class="material-icons" style="color:red; cursor:pointer;" onclick="window.removeCategory(${i})">delete</i></div>`);
        }
        window.addMember = async () => { const n = document.getElementById('new-member-name').value; if(n){familySettings.members.push(n); await saveSettings(); document.getElementById('new-member-name').value="";}};
        window.removeMember = async (i) => { if(confirm("Eliminare?")){familySettings.members.splice(i,1); await saveSettings();}};
        window.addCategory = async () => { const n = document.getElementById('new-cat-name').value; const c=document.getElementById('new-cat-color').value; if(n){familySettings.categories.push({name:n, color:c}); await saveSettings(); document.getElementById('new-cat-name').value="";}};
        window.removeCategory = async (i) => { if(confirm("Eliminare?")){familySettings.categories.splice(i,1); await saveSettings();}};

        function loadData(section) {
            listContainer.innerHTML = '<div style="text-align:center; padding:30px; color:#ccc;">Caricamento...</div>';
            if (unsubscribe) unsubscribe();
            if (!currentFamily) return;
            const col = `${currentFamily}_${section}`;
            
            let q;
            if (section === 'calendar') {
                q = query(collection(db, col), orderBy("date", "asc"));
            } else {
                q = query(collection(db, col), orderBy("timestamp", "desc"));
            }
            
            unsubscribe = onSnapshot(q, (snap) => {
                allDataCache = []; snap.forEach(d => allDataCache.push({id:d.id, ...d.data()}));
                renderList();
            });
        }

        window.applyFilter = () => renderList();

        function renderList() {
            listContainer.innerHTML = "";
            const filter = filterSelect.value;
            const filtered = allDataCache.filter(i => filter === 'all' || i.category === filter);
            
            if(filtered.length === 0) listContainer.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:40px'>Nessun elemento.</div>";

            let scrolled = false;
            const today = new Date().toISOString().split('T')[0];

            filtered.forEach(data => {
                const div = document.createElement('div'); 
                
                if (currentSection === 'notes') {
                    div.className = 'card note-card';
                    div.innerHTML = `<div class="note-title">${data.title||"Senza titolo"}</div><div class="note-body">${data.text}</div><div class="note-footer"><i class="material-icons" style="color:#fbc02d; cursor:pointer;" onclick="window.editNote('${data.id}')">edit</i><i class="material-icons" style="color:#ff5252; cursor:pointer;" onclick="window.del('${data.id}')">delete</i></div>`;
                    listContainer.appendChild(div);
                    return;
                }

                div.className = 'card';
                if (currentSection === 'calendar' && !scrolled && data.date >= today) {
                    div.id = "scroll-target"; scrolled = true;
                    if(data.date === today) div.classList.add('today-card');
                }

                const catObj = familySettings.categories.find(c => c.name === data.category);
                const color = catObj ? catObj.color : '#ccc';
                const assigned = data.assigned ? `<span class="assigned-badge">${data.assigned}</span>` : "";
                
                let html = "", actions = "";
                if(currentSection === 'calendar' || currentSection === 'todos') {
                   const dStr = data.date || new Date().toISOString().split('T')[0];
                   actions = `<i class="material-icons" style="color:#ccc; margin-left:10px; cursor:pointer;" onclick="window.exportGoogle('${data.text}','${dStr}')">event</i>`;
                }

                if (currentSection === 'calendar') {
                    const d = new Date(data.date);
                    // ORARIO
                    const timeDisplay = data.time ? `<span class="time-display">${data.time}</span>` : "";
                    
                    html = `<div class="date-badge"><span class="date-day">${d.getDate()}</span><span class="date-month">${d.toLocaleString('it-IT',{month:'short'})}</span></div>
                            <div style="flex-grow:1"><div style="font-weight:600; font-size:1.1rem; margin-bottom:4px;">${timeDisplay}${data.text}</div>
                            <div style="font-size:0.8rem; color:#666;"><span class="cat-dot" style="background:${color}"></span>${data.category||'Generale'} ${assigned}</div></div>`;
                } else if (currentSection === 'contacts') {
                    html = `<div style="flex-grow:1"><div style="font-weight:600; font-size:1.1rem;">${data.text}</div><a href="tel:${data.detail}" style="color:#4285f4; text-decoration:none; display:flex; align-items:center; margin-top:5px;"><i class="material-icons" style="font-size:16px; margin-right:5px;">call</i>${data.detail}</a></div>`;
                } else if (currentSection === 'todos') {
                    const strike = data.done ? 'text-decoration:line-through; color:#ccc;' : '';
                    const checkColor = data.done ? '#4285f4' : '#ccc';
                    // SCADENZA
                    let dueDateHtml = "";
                    if(data.date) {
                        const dd = new Date(data.date);
                        dueDateHtml = `<span class="due-date-display">Scadenza: ${dd.getDate()}/${dd.getMonth()+1}</span>`;
                    }

                    html = `<i class="material-icons" style="color:${checkColor}; margin-right:15px; cursor:pointer;" onclick="window.toggle('${data.id}',${!data.done})">${data.done ? 'check_circle' : 'radio_button_unchecked'}</i>
                            <div style="flex-grow:1; ${strike}">
                                <span class="cat-dot" style="background:${color}"></span>${data.text} ${assigned}
                                ${dueDateHtml}
                            </div>`;
                } else {
                    const strike = data.done ? 'text-decoration:line-through; color:#ccc;' : '';
                    const checkColor = data.done ? '#4285f4' : '#ccc';
                    html = `<i class="material-icons" style="color:${checkColor}; margin-right:15px; cursor:pointer;" onclick="window.toggle('${data.id}',${!data.done})">${data.done ? 'check_circle' : 'radio_button_unchecked'}</i>
                            <div style="flex-grow:1; ${strike}"><span class="cat-dot" style="background:${color}"></span>${data.text} ${assigned}</div>`;
                }

                div.innerHTML = `${html} <div style="display:flex; align-items:center;">${actions}<i class="material-icons" style="color:#ff5252; margin-left:15px; cursor:pointer;" onclick="window.del('${data.id}')">delete</i></div>`;
                listContainer.appendChild(div);
            });

            if(currentSection === 'calendar') {
                setTimeout(() => {
                    const el = document.getElementById('scroll-target');
                    if(el) el.scrollIntoView({behavior: "smooth", block: "center"});
                }, 300);
            }
        }

        document.getElementById('add-btn').addEventListener('click', async () => {
            const txt = newItemInput.value; if(!txt) return;
            const cat = categorySelect.value; const rec = recurrenceSelect.value; const who = assignWho.value; 
            let dVal = dateInput.value;
            const tVal = timeInput.value; 

            let loops = 1; if(currentSection === 'calendar' && rec !== 'none') loops = (rec==='weekly'?4 : (rec==='monthly'?6:5));
            
            for(let i=0; i<loops; i++) {
                const item = { text: txt, timestamp: serverTimestamp(), done: false, category: cat, assigned: who };
                
                if(currentSection === 'calendar') {
                    if(!dVal) return alert("Inserisci Data");
                    item.time = tVal; 
                    if(i>0) { const d = new Date(dVal); if(rec==='weekly') d.setDate(d.getDate()+(7*i)); if(rec==='monthly') d.setMonth(d.getMonth()+i); if(rec==='yearly') d.setFullYear(d.getFullYear()+i); item.date = d.toISOString().split('T')[0]; } else item.date = dVal;
                }
                
                if(currentSection === 'todos') {
                    if(dVal) item.date = dVal; 
                }

                if(currentSection === 'contacts') item.detail = contactInput.value || "";
                await addDoc(collection(db, `${currentFamily}_${currentSection}`), item);
                if(currentSection !== 'calendar') break;
            }
            newItemInput.value=""; contactInput.value=""; recurrenceSelect.value="none"; timeInput.value=""; dateInput.value="";
        });

        document.getElementById('save-note-btn').addEventListener('click', async () => {
            const title = noteTitleInput.value; const content = noteContentInput.value; const editId = editingNoteId.value;
            if(!content) return alert("Scrivi qualcosa!");
            if (editId) { await updateDoc(doc(db, `${currentFamily}_notes`, editId), { title: title, text: content, timestamp: serverTimestamp() }); editingNoteId.value = ""; document.getElementById('save-note-btn').innerText = "SALVA NOTA"; } 
            else { await addDoc(collection(db, `${currentFamily}_notes`), { title: title, text: content, timestamp: serverTimestamp() }); }
            noteTitleInput.value = ""; noteContentInput.value = "";
        });

        window.del = async (id) => { if(confirm("Eliminare?")) await deleteDoc(doc(db, `${currentFamily}_${currentSection}`, id)); };
        window.toggle = async (id, st) => { if(currentSection!=='calendar' && currentSection!=='contacts' && currentSection!=='notes') await updateDoc(doc(db, `${currentFamily}_${currentSection}`, id), {done:st}); };
        window.editNote = (id) => { const note = allDataCache.find(n => n.id === id); if (note) { noteTitleInput.value = note.title || ""; noteContentInput.value = note.text || ""; editingNoteId.value = id; document.getElementById('save-note-btn').innerText = "AGGIORNA NOTA"; window.scrollTo({ top: 0, behavior: 'smooth' });}};
        window.exportGoogle = (t,d) => { const x=d.replace(/-/g,''); window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t)}&dates=${x}/${x}`,'_blank');};

    </script>
        <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrato!', reg.scope))
                    .catch(err => console.log('SW fallito:', err));
            });
        }
    </script>

</body>
</html>

</body>
</html>

